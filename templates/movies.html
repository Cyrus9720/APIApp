<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movie Search</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="container">
    <h1>Movie Search</h1>

    <div class="user-bar">
        <span class="user-label">Logged in as <strong>{{ username }}</strong></span>
        <a href="/my_list" class="logout-btn">My list</a>
        <a href="/logout" class="logout-btn">Logout</a>
    </div>

    <form id="search-form" class="search-form">
        <select name="type" id="search-type" class="search-type">
            <option value="film">Film</option>
            <option value="director">Director</option>
        </select>
        <input type="text" name="q" id="search-input" placeholder="Search for a movie...">
        <button type="submit">Search</button>
        <a href="/wrapped" class="btn-search">Show Wrapped</a>
    </form>

    <p id="no-results" style="display: none;">No results found.</p>
    <div id="results" class="results"></div>
</div>

<div id="toast-container" class="toast-container"></div>

<script>
// Helper: format runtime
function formatRuntime(minutes) {
    if (!minutes) return "Unknown";
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    if (h === 0) return `${m} min`;
    if (m === 0) return `${h} h`;
    return `${h} h ${m} min`;
}

// Toast notification
function showToast(message, type = "info") {
    const container = document.getElementById("toast-container");
    container.innerHTML = "";
    const toast = document.createElement("div");
    toast.classList.add("toast", `toast-${type}`);
    toast.textContent = message;
    container.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add("show"));
    setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 200);
    }, 2000);
}

// Render movie cards
function renderMovies(movies) {
    const resultsDiv = document.getElementById("results");
    const noResults = document.getElementById("no-results");
    
    if (!movies || movies.length === 0) {
        resultsDiv.innerHTML = "";
        noResults.style.display = "block";
        return;
    }
    
    noResults.style.display = "none";
    resultsDiv.innerHTML = movies.map(movie => `
        <div class="movie-card">
            ${movie.poster_url 
                ? `<img src="${movie.poster_url}" alt="${movie.title} poster">`
                : `<div class="no-poster">No poster</div>`}
            <div class="movie-info">
                <h2>${movie.title}</h2>
                <p><strong>Release:</strong> ${movie.release_date || "Unknown"}</p>
                <p><strong>Director:</strong> ${movie.director || "Unknown"}</p>
                <p><strong>Rating:</strong> ${movie.rating ? movie.rating.toFixed(1) : "N/A"}</p>
                ${movie.runtime ? `<p><strong>Runtime:</strong> ${formatRuntime(movie.runtime)}</p>` : ""}
                ${movie.genres && movie.genres.length ? `<p><strong>Genres:</strong> ${movie.genres.join(", ")}</p>` : ""}
                <button class="add-to-list-btn" 
                    data-id="${movie.id}"
                    data-title="${movie.title}"
                    data-poster="${movie.poster_url || ''}"
                    data-release="${movie.release_date || ''}"
                    data-rating="${movie.rating || 0}"
                    data-director="${movie.director || ''}"
                    data-runtime="${movie.runtime || 0}"
                    data-genres="${(movie.genres || []).join(', ')}">
                    Add to my list
                </button>
            </div>
        </div>
    `).join("");
    
    // Attach click handlers for add buttons
    resultsDiv.querySelectorAll(".add-to-list-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
            const formData = new FormData();
            formData.append("id", btn.dataset.id);
            formData.append("title", btn.dataset.title);
            formData.append("poster_url", btn.dataset.poster);
            formData.append("release_date", btn.dataset.release);
            formData.append("rating", btn.dataset.rating);
            formData.append("director", btn.dataset.director);
            formData.append("runtime", btn.dataset.runtime);
            formData.append("genres", btn.dataset.genres);
            
            try {
                const response = await fetch("/api/favorites", {
                    method: "POST",
                    body: formData
                });
                if (response.ok) {
                    showToast("Movie added to your list");
                } else {
                    const data = await response.json();
                    showToast(data.message || "Error adding movie", "error");
                }
            } catch (err) {
                showToast("Network error", "error");
            }
        });
    });
}

// Search via API
document.getElementById("search-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const query = document.getElementById("search-input").value.trim();
    const type = document.getElementById("search-type").value;
    
    if (!query) return;
    
    try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&type=${encodeURIComponent(type)}`);
        const data = await response.json();
        renderMovies(data.movies);
    } catch (err) {
        showToast("Search failed", "error");
    }
});
</script>
</body>
</html>

